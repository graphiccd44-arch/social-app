<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Class Platform (Real Auth)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS STYLES (SAME AS BEFORE) */
        :root { --primary: #6366f1; --bg-body: #f3f4f6; --bg-card: #ffffff; --text-main: #1f2937; --border: #e5e7eb; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); margin: 0; color: var(--text-main); }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #eef2ff; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .toggle-link { margin-top: 15px; font-size: 13px; color: var(--primary); cursor: pointer; text-decoration: underline; display: block; }
        
        /* Main Layout */
        .navbar { background: var(--bg-card); padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .main-layout { display: grid; grid-template-columns: 260px 1fr; gap: 20px; max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .sidebar { background: var(--bg-card); border-radius: 12px; padding: 15px; height: fit-content; border: 1px solid var(--border); position: sticky; top: 80px; }
        .menu-item { padding: 12px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 12px; margin-bottom: 5px; }
        .menu-item.active { background: #eef2ff; color: var(--primary); border-left: 4px solid var(--primary); }
        .section { display: none; } .section.active { display: block; }
        
        /* Elements */
        .card, .gen-card, .create-post, .post { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; }
        .btn-gen { width: 100%; padding: 12px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-post { background: var(--primary); color: white; padding: 8px 20px; border-radius: 8px; border: none; float: right; cursor: pointer; }
        
        @media (max-width: 768px) { .main-layout { grid-template-columns: 1fr; } .sidebar { display: none; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card" id="login-form">
            <h2 style="color:var(--primary);">üöÄ Login</h2>
            <p style="font-size:12px; color:gray; margin-bottom:20px;">Sign in with Email & Password</p>
            <input type="email" id="loginEmail" class="login-input" placeholder="Email">
            <input type="password" id="loginPass" class="login-input" placeholder="Password">
            <button class="login-btn" onclick="handleLogin()">Log In</button>
            <span class="toggle-link" onclick="toggleAuth('register')">Create New Account</span>
        </div>

        <div class="login-card" id="register-form" style="display:none;">
            <h2 style="color:var(--primary);">üÜï Sign Up</h2>
            <p style="font-size:12px; color:gray; margin-bottom:20px;">We will send a verification email.</p>
            <input type="text" id="regName" class="login-input" placeholder="Full Name">
            <input type="email" id="regEmail" class="login-input" placeholder="Email">
            <input type="password" id="regPass" class="login-input" placeholder="Password (Min 6 chars)">
            <button class="login-btn" onclick="handleRegister()" style="background:#10b981;">Sign Up</button>
            <span class="toggle-link" onclick="toggleAuth('login')">Back to Login</span>
        </div>
    </div>

    <div id="app-content" style="display:none;">
        <nav class="navbar">
            <div class="logo" onclick="location.reload()" style="font-size:22px; font-weight:800; color:var(--primary);">üöÄ MyClass</div>
            <div style="font-weight:bold;" id="navUserName">User</div>
        </nav>

        <div class="main-layout">
            <aside class="sidebar">
                <div class="menu-item active" onclick="switchTab('feed')">üè† Feed</div>
                <div class="menu-item" onclick="switchTab('generator')">‚ú® Generator</div>
                <div class="menu-item" onclick="logoutUser()" style="color:red;">üö™ Logout</div>
            </aside>

            <main>
                <div id="feed-section" class="section active">
                    <div class="create-post">
                        <textarea id="postInput" rows="3" placeholder="Post something..."></textarea>
                        <button class="btn-post" onclick="addPost()">Post</button>
                        <div style="clear:both;"></div>
                    </div>
                    <div id="feedStream">Loading...</div>
                </div>

                <div id="generator-section" class="section">
                    <div class="gen-card">
                        <h2>‚ú® AI Content Studio</h2>
                        <input type="text" id="topic" placeholder="Topic">
                        <select id="tone"><option>Professional</option><option>Funny</option></select>
                        <button class="btn-gen" id="genBtn" onclick="generateContent()">Generate</button>
                        <div id="output" style="background:#f9fafb; padding:15px; margin-top:15px; border:1px solid #ddd; min-height:100px;"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        // Import Auth
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification, updateProfile } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAFLolC6hEYro24FAFrKTGrXe4WXvISv3M",
            authDomain: "myclassfeed-766f9.firebaseapp.com",
            projectId: "myclassfeed-766f9",
            storageBucket: "myclassfeed-766f9.firebasestorage.app",
            messagingSenderId: "428491793200",
            appId: "1:428491793200:web:dc8b769278b0e981d29ef5"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // üîê KEYS
        const ENCODED_KEY = "QUl6YVN5Q1Z6YUEyQlJGYndfbmcxVmpRWldYNU55TlAtZlItYURR"; 
        const MODEL_NAME = "gemini-2.5-flash";

        // --- AUTH LOGIC (THE REAL DEAL) ---
        
        window.toggleAuth = (view) => {
            document.getElementById('login-form').style.display = view === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = view === 'register' ? 'block' : 'none';
        }

        // 1. REGISTER
        window.handleRegister = async () => {
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;

            if(pass.length < 6) { alert("Password must be at least 6 characters"); return; }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                
                // Add Name
                await updateProfile(user, { displayName: name });
                
                // Send Verification Email
                await sendEmailVerification(user);
                
                alert("‚úÖ Account Created!\nPlease check your email (" + email + ") to verify your account before logging in.");
                window.toggleAuth('login');
                
            } catch (error) {
                alert("Error: " + error.message);
            }
        }

        // 2. LOGIN
        window.handleLogin = async () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;

                if (!user.emailVerified) {
                    alert("‚ö†Ô∏è Please verify your email address first! Check your inbox.");
                    await signOut(auth); // Log them out if not verified
                    return;
                }
                // Success is handled by onAuthStateChanged
            } catch (error) {
                alert("Login Failed: " + error.message);
            }
        }

        // 3. LOGOUT
        window.logoutUser = () => signOut(auth);

        // 4. AUTH STATE LISTENER
        onAuthStateChanged(auth, (user) => {
            if (user && user.emailVerified) {
                // User is logged in & verified
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('navUserName').innerText = user.displayName || "User";
            } else {
                // User is logged out
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
            }
        });

        // --- OTHERS ---
        window.switchTab = (t) => {
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
            document.getElementById(t+'-section').classList.add('active');
        }

        window.generateContent = async function() {
            const topic = document.getElementById('topic').value;
            const btn = document.getElementById('genBtn');
            const output = document.getElementById('output');
            
            if(!topic) return;
            let REAL_KEY = ""; try { REAL_KEY = atob(ENCODED_KEY); } catch(e) { return; }
            
            btn.innerText = "Thinking...";
            const prompt = `Write a post about "${topic}" in Burmese.`;
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${REAL_KEY}`, {
                    method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({contents:[{parts:[{text:prompt}]}]})
                });
                const d = await res.json();
                output.innerText = d.candidates[0].content.parts[0].text;
            } catch(e) { output.innerText = "Error"; }
            btn.innerText = "Generate";
        }

        window.addPost = async () => {
            const txt = document.getElementById('postInput').value;
            if(!txt) return;
            await addDoc(collection(db, "posts"), { 
                content: txt, 
                username: auth.currentUser.displayName || "User", 
                timestamp: serverTimestamp() 
            });
            document.getElementById('postInput').value = "";
        }

        onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), (s)=>{
            const f = document.getElementById('feedStream'); f.innerHTML = "";
            s.forEach(d => f.innerHTML += `<div class="post"><b>${d.data().username}</b><br>${d.data().content}</div>`);
        });
    </script>
</body>
</html>
